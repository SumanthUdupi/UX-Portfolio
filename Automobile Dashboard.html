<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Automobile Insights Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #F1F5F9; /* slate-100 */
            --bg-secondary: #FFFFFF; /* white */
            --bg-tertiary: #E2E8F0; /* slate-200 */
            --border-color: #CBD5E1; /* slate-300 */
            --text-primary: #1E293B; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --accent-primary: #0EA5E9; /* sky-500 */
            --accent-secondary: #6366F1; /* indigo-500 */
            --accent-positive: #10B981; /* emerald-500 */
            --accent-negative: #EF4444; /* red-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .sidebar {
            background-color: #0F172A; /* slate-900 */
            color: var(--bg-primary);
        }
        .sidebar-item {
            color: #94A3B8; /* slate-400 */
        }
        .sidebar-item:hover {
            background-color: #1E293B; /* slate-800 */
            color: #F1F5F9; /* slate-100 */
        }
        .sidebar-item.active {
            background-color: var(--accent-primary);
            color: white;
            font-weight: 600;
        }
        .chart-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .chart-container:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border-color: var(--accent-primary);
        }
        .kpi-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .filter-select, .reset-button {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .filter-select:hover, .reset-button:hover {
            border-color: var(--accent-primary);
        }
        .reset-button {
             background-color: var(--accent-negative);
             color: white;
             border-color: var(--accent-negative);
        }
        .reset-button:hover {
            opacity: 0.8;
        }
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 0.75rem;
            font-size: 0.875rem;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            color: white;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .axis path,
        .axis line {
            stroke: var(--border-color);
        }
        .axis text {
            fill: var(--text-secondary);
            font-size: 12px;
        }
        .view-content { display: none; }
        .view-content.active { display: block; }
        .clickable { cursor: pointer; }
        .clickable:hover { opacity: 0.8; }
        .cross-filter-dim { opacity: 0.3; transition: opacity 0.3s ease; }
        .legend-item.hidden { opacity: 0.4; text-decoration: line-through; }
    </style>
</head>
<body class="antialiased">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 p-6 flex flex-col sidebar">
            <h1 class="text-2xl font-bold mb-10">Automobile Insights</h1>
            <nav id="sidebar-nav" class="flex-grow">
                <ul>
                    <li><a href="#" class="sidebar-item flex items-center px-4 py-3 rounded-lg transition-colors duration-200 active" data-view="overview">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                        Overview</a></li>
                    <li><a href="#" class="sidebar-item flex items-center mt-2 px-4 py-3 rounded-lg transition-colors duration-200" data-view="pricing_market">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Pricing & Market</a></li>
                    <li><a href="#" class="sidebar-item flex items-center mt-2 px-4 py-3 rounded-lg transition-colors duration-200" data-view="performance">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Performance</a></li>
                    <li><a href="#" class="sidebar-item flex items-center mt-2 px-4 py-3 rounded-lg transition-colors duration-200" data-view="engine_fuel">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z" clip-rule="evenodd" /></svg>
                        Engine & Fuel</a></li>
                     <li><a href="#" class="sidebar-item flex items-center mt-2 px-4 py-3 rounded-lg transition-colors duration-200" data-view="risk_safety">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.494v17.072a1.432 1.432 0 01-1.432 1.432H4.814A1.432 1.432 0 013.382 18.578V7.422c0-.79.642-1.432 1.432-1.432h11.372a1.432 1.432 0 011.432 1.432z"></path></svg>
                        Risk & Safety</a></li>
                    <li><a href="#" class="sidebar-item flex items-center mt-2 px-4 py-3 rounded-lg transition-colors duration-200" data-view="correlation">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                        Correlations</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            <header class="mb-8">
                <h2 id="dashboard-title" class="text-3xl font-bold text-slate-800">Automobile Insights Dashboard</h2>
                <p class="text-lg text-slate-500 mt-1">An interactive exploration of automobile data.</p>
            </header>

            <!-- Filters -->
            <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6 mb-8">
                <div>
                    <label for="make-filter" class="text-slate-600 mr-2 font-medium">Filter by Make:</label>
                    <select id="make-filter" class="filter-select p-2 rounded-md w-48"></select>
                </div>
                <div>
                    <label for="body-style-filter" class="text-slate-600 mr-2 font-medium">Filter by Body Style:</label>
                    <select id="body-style-filter" class="filter-select p-2 rounded-md w-48"></select>
                </div>
                <button id="reset-filter-btn" class="reset-button p-2 rounded-md font-semibold">Reset Cross-Filter</button>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="kpi-card p-6 rounded-lg text-center"><h3 class="text-slate-500 text-lg">Total Cars</h3><p id="total-cars" class="text-4xl font-bold text-sky-500 mt-2">0</p></div>
                <div class="kpi-card p-6 rounded-lg text-center"><h3 class="text-slate-500 text-lg">Average Price</h3><p id="avg-price" class="text-4xl font-bold text-sky-500 mt-2">$0</p></div>
                <div class="kpi-card p-6 rounded-lg text-center"><h3 class="text-slate-500 text-lg">Average Horsepower</h3><p id="avg-horsepower" class="text-4xl font-bold text-sky-500 mt-2">0</p></div>
                <div class="kpi-card p-6 rounded-lg text-center"><h3 class="text-slate-500 text-lg">Average MPG (City)</h3><p id="avg-mpg" class="text-4xl font-bold text-sky-500 mt-2">0</p></div>
            </div>

            <!-- View Content Area -->
            <div id="view-container">
                <div id="overview-view" class="view-content active"><div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="chart-container lg:col-span-3"><h2 id="price-dist-title" class="text-xl font-bold text-slate-700 mb-4 text-center">Price Distribution</h2><svg id="price-distribution" class="w-full h-80"></svg></div>
                    <div class="chart-container lg:col-span-2"><h2 id="body-style-title" class="text-xl font-bold text-slate-700 mb-4 text-center">Vehicles by Body Style</h2><svg id="cars-by-body-style" class="w-full h-80"></svg></div>
                    <div class="chart-container lg:col-span-5"><h2 id="make-count-title" class="text-xl font-bold text-slate-700 mb-4 text-center">Count of Vehicles by Make</h2><svg id="cars-by-make" class="w-full h-96"></svg></div>
                </div></div>
                <div id="pricing_market-view" class="view-content"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="chart-container lg:col-span-2"><h2 id="avg-price-make-title" class="text-xl font-bold text-slate-700 mb-4 text-center">Average Price by Make</h2><svg id="avg-price-by-make" class="w-full h-96"></svg></div>
                    <div class="chart-container"><h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Price Distribution by Body Style</h2><svg id="price-by-body-style-box" class="w-full h-96"></svg></div>
                    <div class="chart-container"><h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Price vs. Horsepower</h2><svg id="price-vs-horsepower-scatter" class="w-full h-96"></svg></div>
                </div></div>
                <div id="performance-view" class="view-content"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="chart-container"><h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Horsepower Distribution by Drive Wheels</h2><svg id="hp-by-drive-wheels-violin" class="w-full h-96"></svg></div>
                    <div class="chart-container"><h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Curb Weight vs. Price</h2><svg id="curb-weight-vs-price" class="w-full h-96"></svg></div>
                    <div class="chart-container lg:col-span-2"><h2 class="text-xl font-bold text-slate-700 mb-4 text-center">City MPG vs. Highway MPG</h2><div id="mpg-scatter-legend" class="flex flex-wrap justify-center gap-x-4 gap-y-2 mb-2"></div><svg id="mpg-scatter" class="w-full h-96"></svg></div>
                </div></div>
                <div id="engine_fuel-view" class="view-content"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="chart-container"><h2 class="text-xl font-bold text-slate-700 mb-4 text-center">HP by Fuel Type & Aspiration</h2><svg id="hp-by-aspiration" class="w-full h-96"></svg></div>
                    <div class="chart-container"><h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Engine Size vs. Horsepower</h2><svg id="engine-vs-hp" class="w-full h-96"></svg></div>
                </div></div>
                <div id="risk_safety-view" class="view-content"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="chart-container"><h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Insurance Risk Rating Distribution</h2><svg id="symboling-dist" class="w-full h-96"></svg></div>
                    <div class="chart-container"><h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Price by Insurance Risk Rating</h2><svg id="price-by-symboling" class="w-full h-96"></svg></div>
                </div></div>
                <div id="correlation-view" class="view-content"><div class="chart-container">
                    <h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Feature Correlation Matrix</h2><svg id="correlation-heatmap" class="w-full h-[36rem]"></svg>
                </div></div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Data source
        const csvUrl = 'Rawdata/Automobile_data.csv';

        // --- Global State ---
        let fullDataset = [];
        let activeView = 'overview';
        let crossFilter = { key: null, value: null };
        let hiddenLegendItems = new Set();
        
        const tooltip = d3.select("body").append("div").attr("class", "tooltip");
        const margin = {top: 30, right: 30, bottom: 60, left: 70};
        const marginRotated = {top: 30, right: 30, bottom: 100, left: 70};

        // --- Data Loading and Initialization ---
        d3.csv(csvUrl, (d) => {
            // This function is applied to each row of the CSV to parse and clean it.
            const newRow = {};
            for (const key in d) {
                const val = d[key].trim();
                // Replace '?' with undefined for missing numerical values
                if (val === '?') {
                    newRow[key.trim()] = undefined;
                } else {
                    const numVal = +val; // Attempt to convert to number
                    newRow[key.trim()] = isNaN(numVal) ? val : numVal;
                }
            }
            return newRow;
        }).then(data => {
            // This block runs after all data is loaded and parsed.
            // Filter out rows with essential missing data for a cleaner dataset
            fullDataset = data.filter(d => d.price && d.horsepower && d['city-mpg'] && d['highway-mpg'] && d['curb-weight'] && d.symboling);
            
            // Populate dropdown filters
            populateFilters();

            // Initial dashboard render
            updateDashboard();
        }).catch(error => {
            console.error('Error loading or parsing data:', error);
            document.getElementById('view-container').innerHTML = `<div class="text-red-500 text-center p-8 text-xl">
                <h2 class="text-3xl font-bold mb-4">Error Loading Data</h2>
                <p>Could not load data from the specified URL. Please ensure 'Automobile_data.csv' is accessible and correctly formatted.</p>
            </div>`;
        });
        
        function populateFilters() {
            const makeFilter = d3.select('#make-filter');
            const bodyStyleFilter = d3.select('#body-style-filter');
            // Using Set to get unique values, then sorting
            const makes = ['All', ...new Set(fullDataset.map(d => d.make))].sort();
            const bodyStyles = ['All', ...new Set(fullDataset.map(d => d['body-style']))].sort();
            
            makeFilter.selectAll('option').data(makes).enter().append('option').text(d => d).attr('value', d => d);
            bodyStyleFilter.selectAll('option').data(bodyStyles).enter().append('option').text(d => d).attr('value', d => d);
        }

        // --- Event Listeners ---
        d3.select('#make-filter').on('change', () => updateDashboard());
        d3.select('#body-style-filter').on('change', () => updateDashboard());
        d3.select('#reset-filter-btn').on('click', () => {
            crossFilter = { key: null, value: null };
            updateDashboard();
        });
        d3.select('#sidebar-nav').selectAll('.sidebar-item').on('click', function(event) {
            event.preventDefault();
            d3.selectAll('.sidebar-item').classed('active', false);
            d3.select(this).classed('active', true);
            activeView = d3.select(this).attr('data-view');
            
            d3.selectAll('.view-content').classed('active', false);
            d3.select(`#${activeView}-view`).classed('active', true);
            
            updateDashboard();
        });
        window.addEventListener('resize', () => updateDashboard(false));

        // --- Core Update Function ---
        function updateDashboard(animate = true) {
            const selectedMake = d3.select('#make-filter').property('value');
            const selectedBodyStyle = d3.select('#body-style-filter').property('value');

            let filteredData = fullDataset;
            // Apply dropdown filters
            if (selectedMake !== 'All') {
                filteredData = filteredData.filter(d => d.make === selectedMake);
            }
            if (selectedBodyStyle !== 'All') {
                filteredData = filteredData.filter(d => d['body-style'] === selectedBodyStyle);
            }
            
            // Apply cross-filter if it exists
            if (crossFilter.key && crossFilter.value) {
                filteredData = filteredData.filter(d => d[crossFilter.key] === crossFilter.value);
            }
            
            // Apply legend filter
            if (hiddenLegendItems.size > 0) {
                 filteredData = filteredData.filter(d => !hiddenLegendItems.has(d.make));
            }

            updateKPIs(filteredData);
            updateDynamicTitles(selectedMake, selectedBodyStyle);
            drawActiveViewCharts(filteredData, animate);
        }
        
        function setCrossFilter(key, value) {
            // If clicking the same filter, disable it. Otherwise, set the new one.
            if (crossFilter && crossFilter.key === key && crossFilter.value === value) {
                crossFilter = { key: null, value: null };
            } else {
                crossFilter = { key, value };
            }
            updateDashboard();
        }

        function updateKPIs(data) {
            d3.select('#total-cars').text(data.length);
            const avgPrice = d3.mean(data, d => d.price);
            d3.select('#avg-price').text(avgPrice ? `$${d3.format(",.0f")(avgPrice)}` : 'N/A');
            const avgHorsepower = d3.mean(data, d => d.horsepower);
            d3.select('#avg-horsepower').text(avgHorsepower ? d3.format(".0f")(avgHorsepower) : 'N/A');
            const avgMpg = d3.mean(data, d => d['city-mpg']);
            d3.select('#avg-mpg').text(avgMpg ? d3.format(".1f")(avgMpg) : 'N/A');
        }
        
        function updateDynamicTitles(make, bodyStyle) {
            let title = "Automobile Insights Dashboard";
            if (make !== 'All') title += ` | ${make}`;
            if (bodyStyle !== 'All') title += ` | ${bodyStyle}`;
            if (crossFilter.value) title += ` | Cross-Filter: ${crossFilter.value}`;
            d3.select('#dashboard-title').text(title);

            // Update individual chart titles
            d3.select('#price-dist-title').text(`Price Distribution` + (make !== 'All' ? ` for ${make}` : ''));
            d3.select('#body-style-title').text(`Vehicles by Body Style` + (make !== 'All' ? ` for ${make}` : ''));
            d3.select('#make-count-title').text(`Count of Vehicles by Make`);
            d3.select('#avg-price-make-title').text(`Average Price by Make` + (bodyStyle !== 'All' ? ` for ${bodyStyle}s` : ''));
        }

        function drawActiveViewCharts(data, animate) {
            if (data.length === 0) {
                d3.selectAll('.chart-container svg').html('<text x="50%" y="50%" text-anchor="middle" fill="#94A3B8">No data for selected filters.</text>');
                return;
            }

            switch(activeView) {
                case 'overview':
                    drawPriceDistribution(data, animate);
                    drawCarsByBodyStyle(data, animate);
                    drawCarsByMake(data, animate);
                    break;
                case 'pricing_market':
                    drawAvgPriceByMake(data, animate);
                    drawBoxPlot(data, '#price-by-body-style-box', 'body-style', 'price', 'Body Style', 'Price ($)', animate);
                    drawScatterPlot(data, '#price-vs-horsepower-scatter', 'horsepower', 'price', 'Horsepower', 'Price ($)', animate, 'make');
                    break;
                case 'performance':
                    drawViolinPlot(data, '#hp-by-drive-wheels-violin', 'drive-wheels', 'horsepower', 'Drive Wheels', 'Horsepower', animate);
                    drawScatterPlot(data, '#curb-weight-vs-price', 'curb-weight', 'price', 'Curb Weight (lbs)', 'Price ($)', animate, 'make');
                    drawScatterPlot(data, '#mpg-scatter', 'city-mpg', 'highway-mpg', 'City MPG', 'Highway MPG', animate, 'make', '#mpg-scatter-legend');
                    break;
                case 'engine_fuel':
                    drawGroupedBoxPlot(data, '#hp-by-aspiration', 'fuel-type', 'aspiration', 'horsepower', 'Fuel Type', 'Horsepower', animate);
                    drawScatterPlot(data, '#engine-vs-hp', 'engine-size', 'horsepower', 'Engine Size', 'Horsepower', animate, 'fuel-type');
                    break;
                case 'risk_safety':
                    drawSymbolingDistribution(data, animate);
                    drawBoxPlot(data, '#price-by-symboling', 'symboling', 'price', 'Insurance Risk Rating (Symboling)', 'Price ($)', animate);
                    break;
                case 'correlation':
                    drawCorrelationHeatmap(data, animate);
                    break;
            }
        }
        
        // --- Chart Drawing Functions ---
        // Note: Many functions are generalized to be reusable (e.g., drawScatterPlot, drawBoxPlot)

        function drawPriceDistribution(data, animate) {
            const svg = d3.select("#price-distribution");
            svg.selectAll("*").remove();
            const width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = svg.node().getBoundingClientRect().height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain(d3.extent(data, d => d.price)).nice().range([0, width]);
            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).ticks(7).tickFormat(d3.format("~s")))
                .append("text").attr("y", 40).attr("x", width/2).attr("text-anchor", "middle").attr("fill", "currentColor").text("Price ($)");

            const histogram = d3.histogram().value(d => d.price).domain(x.domain()).thresholds(x.ticks(20));
            const bins = histogram(data);

            const y = d3.scaleLinear().range([height, 0]).domain([0, d3.max(bins, d => d.length)]).nice();
            g.append("g").call(d3.axisLeft(y));

            g.selectAll("rect").data(bins).join("rect")
                .attr("x", 1).attr("transform", d => `translate(${x(d.x0)},${y(d.length)})`)
                .attr("width", d => Math.max(0, x(d.x1) - x(d.x0) - 1))
                .attr("fill", "var(--accent-primary)")
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1);
                    tooltip.html(`<b>Price Range:</b> $${d.x0.toLocaleString()} - $${d.x1.toLocaleString()}<br><b>Count:</b> ${d.length}`)
                        .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                }).on("mouseout", () => tooltip.style("opacity", 0))
                .attr("y", y(0))
                .attr("height", 0)
                .transition().duration(animate ? 800 : 0)
                .attr("y", d => y(d.length))
                .attr("height", d => height - y(d.length));
        }
        
        function drawCarsByBodyStyle(data, animate) {
            const svg = d3.select("#cars-by-body-style");
            svg.selectAll("*").remove();
            const width = svg.node().getBoundingClientRect().width;
            const height = svg.node().getBoundingClientRect().height;
            const radius = Math.min(width, height) / 2 - 20;
            const g = svg.append("g").attr("transform", `translate(${width / 2}, ${height / 2})`);

            const counts = d3.rollup(data, v => v.length, d => d['body-style']);
            const countsArray = Array.from(counts, ([key, value]) => ({type: key, count: value}));
            
            const color = d3.scaleOrdinal(d3.schemeTableau10).domain(countsArray.map(d=>d.type));
            const pie = d3.pie().value(d => d.count).sort(null);
            const data_ready = pie(countsArray);

            const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius);

            g.selectAll("path").data(data_ready).join("path")
                .attr('d', arc)
                .attr('fill', d => color(d.data.type))
                .attr("stroke", "var(--bg-secondary)").style("stroke-width", "3px")
                .attr("class", "clickable")
                .classed("cross-filter-dim", d => crossFilter.key === 'body-style' && crossFilter.value && crossFilter.value !== d.data.type)
                .on("click", (event, d) => setCrossFilter('body-style', d.data.type))
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1);
                    tooltip.html(`<b>${d.data.type}</b><br>Count: ${d.data.count} (${d3.format(".1%")(d.data.count / data.length)})`)
                        .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                    d3.select(event.currentTarget).transition().duration(200).attr('transform', 'scale(1.05)');
                }).on("mouseout", (event) => {
                    tooltip.style("opacity", 0);
                    d3.select(event.currentTarget).transition().duration(200).attr('transform', 'scale(1)');
                })
                .transition().duration(animate ? 1000 : 0)
                .attrTween('d', function(d) {
                    const i = d3.interpolate(this._current || {startAngle: 0, endAngle: 0}, d);
                    this._current = i(0);
                    return t => arc(i(t));
                });
        }

        function drawCarsByMake(data, animate) {
            const svg = d3.select("#cars-by-make");
            svg.selectAll("*").remove();
            const width = svg.node().getBoundingClientRect().width - marginRotated.left - marginRotated.right;
            const height = svg.node().getBoundingClientRect().height - marginRotated.top - marginRotated.bottom;
            const g = svg.append("g").attr("transform", `translate(${marginRotated.left},${marginRotated.top})`);

            const counts = d3.rollup(data, v => v.length, d => d.make);
            const countsArray = Array.from(counts, ([key, value]) => ({make: key, count: value}))
                .sort((a, b) => d3.descending(a.count, b.count));

            const x = d3.scaleBand().range([0, width]).domain(countsArray.map(d => d.make)).padding(0.2);
            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
                .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");

            const y = d3.scaleLinear().domain([0, d3.max(countsArray, d => d.count)]).nice().range([height, 0]);
            g.append("g").call(d3.axisLeft(y));

            g.selectAll("rect").data(countsArray).join("rect")
                .attr("x", d => x(d.make)).attr("width", x.bandwidth())
                .attr("fill", "var(--accent-secondary)")
                .attr("class", "clickable")
                .classed("cross-filter-dim", d => crossFilter.key === 'make' && crossFilter.value && crossFilter.value !== d.make)
                .on("click", (event, d) => setCrossFilter('make', d.make))
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1);
                    tooltip.html(`<b>${d.make}</b><br>Count: ${d.count}`)
                        .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                }).on("mouseout", () => tooltip.style("opacity", 0))
                .attr("y", y(0)).attr("height", 0)
                .transition().duration(animate ? 800 : 0)
                .attr("y", d => y(d.count))
                .attr("height", d => height - y(d.count));
        }

        function drawAvgPriceByMake(data, animate) {
            const svg = d3.select("#avg-price-by-make");
            svg.selectAll("*").remove();
            const width = svg.node().getBoundingClientRect().width - marginRotated.left - marginRotated.right;
            const height = svg.node().getBoundingClientRect().height - marginRotated.top - marginRotated.bottom;
            const g = svg.append("g").attr("transform", `translate(${marginRotated.left},${marginRotated.top})`);

            const overallAvgPrice = d3.mean(fullDataset, d => d.price); // Use full dataset for overall average
            const avgPriceData = d3.rollup(data, v => d3.mean(v, d => d.price), d => d.make);
            const avgPriceArray = Array.from(avgPriceData, ([key, value]) => ({make: key, price: value}))
                .sort((a,b) => d3.descending(a.price, b.price));

            const x = d3.scaleBand().range([0, width]).domain(avgPriceArray.map(d => d.make)).padding(0.2);
            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
                .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");

            const y = d3.scaleLinear().domain([0, d3.max(avgPriceArray, d => d.price)]).nice().range([height, 0]);
            g.append("g").call(d3.axisLeft(y).tickFormat(d3.format("~s")));

            g.selectAll("rect").data(avgPriceArray).join("rect")
                .attr("x", d => x(d.make)).attr("width", x.bandwidth())
                .attr("fill", d => d.price > overallAvgPrice ? "var(--accent-positive)" : "var(--accent-negative)")
                .attr("class", "clickable")
                .classed("cross-filter-dim", d => crossFilter.key === 'make' && crossFilter.value && crossFilter.value !== d.make)
                .on("click", (event, d) => setCrossFilter('make', d.make))
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1);
                    const priceDiff = d.price - overallAvgPrice;
                    const diffText = priceDiff > 0 ? `+$${d3.format(",.0f")(Math.abs(priceDiff))}` : `-$${d3.format(",.0f")(Math.abs(priceDiff))}`;
                    tooltip.html(`<b>${d.make}</b><br>Avg Price: $${d3.format(",.0f")(d.price)}<br>Difference from Overall Avg: ${diffText}`)
                        .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                }).on("mouseout", () => tooltip.style("opacity", 0))
                .attr("y", y(0)).attr("height", 0)
                .transition().duration(animate ? 800 : 0)
                .attr("y", d => y(d.price))
                .attr("height", d => height - y(d.price));
            
            // Add average line
            g.append("line")
                .attr("x1", 0).attr("x2", width)
                .attr("y1", y(overallAvgPrice)).attr("y2", y(overallAvgPrice))
                .attr("stroke", "var(--accent-primary)").attr("stroke-width", 2).attr("stroke-dasharray", "5,5");
            g.append("text").attr("x", width).attr("y", y(overallAvgPrice) - 5).attr("text-anchor", "end").attr("fill", "var(--accent-primary)").text("Overall Avg");
        }
        
        function drawSymbolingDistribution(data, animate) {
            const svg = d3.select("#symboling-dist");
            svg.selectAll("*").remove();
            const width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = svg.node().getBoundingClientRect().height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const symbolingMap = {'-2': 'Very Safe', '-1': 'Safe', '0': 'Neutral', '1': 'Risky', '2': 'Very Risky', '3': 'Most Risky'};
            const counts = d3.rollup(data, v => v.length, d => d.symboling);
            const countsArray = Array.from(counts, ([key, value]) => ({symbol: key, name: symbolingMap[key] || key, count: value}))
                .sort((a,b) => d3.ascending(a.symbol, b.symbol));

            const x = d3.scaleBand().range([0, width]).domain(countsArray.map(d => d.symbol)).padding(0.3);
            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d => symbolingMap[d] || d));

            const y = d3.scaleLinear().domain([0, d3.max(countsArray, d => d.count)]).nice().range([height, 0]);
            g.append("g").call(d3.axisLeft(y));
            
            const colorScale = d3.scaleOrdinal().domain(['-2','-1','0','1','2','3'])
                .range(['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444', '#b91c1c']); // green to red

            g.selectAll("rect").data(countsArray).join("rect")
                .attr("x", d => x(d.symbol)).attr("width", x.bandwidth())
                .attr("fill", d => colorScale(d.symbol))
                .attr("class", "clickable")
                .classed("cross-filter-dim", d => crossFilter.key === 'symboling' && crossFilter.value && crossFilter.value !== d.symbol)
                .on("click", (event, d) => setCrossFilter('symboling', d.symbol))
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1);
                    tooltip.html(`<b>${d.name} (Rating: ${d.symbol})</b><br>Count: ${d.count}`)
                        .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                }).on("mouseout", () => tooltip.style("opacity", 0))
                .attr("y", y(0)).attr("height", 0)
                .transition().duration(animate ? 800 : 0)
                .attr("y", d => y(d.count))
                .attr("height", d => height - y(d.count));
        }

        function drawGroupedBoxPlot(data, selector, primaryCat, secondaryCat, numVar, xLabel, yLabel, animate) {
            const svg = d3.select(selector);
            svg.selectAll("*").remove();
            const width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = svg.node().getBoundingClientRect().height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const primaryCategories = [...new Set(data.map(d => d[primaryCat]))].sort();
            const secondaryCategories = [...new Set(data.map(d => d[secondaryCat]))].sort();

            const x0 = d3.scaleBand().range([0, width]).domain(primaryCategories).paddingInner(0.2);
            const x1 = d3.scaleBand().domain(secondaryCategories).range([0, x0.bandwidth()]).padding(0.1);
            
            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x0))
                .append("text").attr("y", 45).attr("x", width/2).attr("text-anchor", "middle").attr("fill", "currentColor").text(xLabel);

            const y = d3.scaleLinear().domain([0, d3.max(data, d => d[numVar])]).nice().range([height, 0]);
            g.append("g").call(d3.axisLeft(y).tickFormat(d3.format("~s")))
                .append("text").attr("transform", "rotate(-90)").attr("y", -55).attr("x", -height/2).attr("text-anchor", "middle").attr("fill", "currentColor").text(yLabel);

            const color = d3.scaleOrdinal().domain(secondaryCategories).range(["var(--accent-primary)", "var(--accent-secondary)"]);

            const groupedData = d3.group(data, d => d[primaryCat], d => d[secondaryCat]);
            
            groupedData.forEach((secondaryGroup, primaryKey) => {
                secondaryGroup.forEach((values, secondaryKey) => {
                    const sortedValues = values.map(d => d[numVar]).sort(d3.ascending);
                    const q1 = d3.quantile(sortedValues, .25);
                    const median = d3.quantile(sortedValues, .5);
                    const q3 = d3.quantile(sortedValues, .75);
                    if (q1 === undefined || median === undefined || q3 === undefined) return;
                    
                    const boxG = g.append("g").attr("transform", `translate(${x0(primaryKey)}, 0)`);
                    
                    boxG.append("rect")
                        .attr("x", x1(secondaryKey))
                        .attr("width", x1.bandwidth())
                        .attr("fill", color(secondaryKey))
                        .on("mouseover", (event) => {
                            tooltip.style("opacity", 1).html(`<b>${primaryKey} - ${secondaryKey}</b><br>Median: ${median.toLocaleString()}<br>Q1: ${q1.toLocaleString()}<br>Q3: ${q3.toLocaleString()}`)
                                .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                        }).on("mouseout", () => tooltip.style("opacity", 0))
                        .transition().duration(animate ? 800 : 0)
                        .attr("y", y(q3))
                        .attr("height", y(q1) - y(q3));
                        
                    boxG.append("line")
                        .attr("x1", x1(secondaryKey)).attr("x2", x1(secondaryKey) + x1.bandwidth())
                        .attr("stroke", "var(--bg-secondary)").style("stroke-width", "2px")
                        .transition().duration(animate ? 800 : 0)
                        .attr("y1", y(median)).attr("y2", y(median));
                });
            });

            // Legend
            const legend = g.selectAll(".legend").data(secondaryCategories).enter().append("g")
                .attr("class", "legend").attr("transform", (d, i) => `translate(${width - 100},${i * 20})`);
            legend.append("rect").attr("x", 0).attr("width", 18).attr("height", 18).style("fill", color);
            legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d);
        }

        function drawScatterPlot(data, selector, xVar, yVar, xLabel, yLabel, animate, hueVar, legendSelector) {
            const svg = d3.select(selector);
            svg.selectAll("*").remove();
            
            const hasLegend = legendSelector && hueVar;
            const currentMargin = hasLegend ? {top: 10, right: 30, bottom: 60, left: 70} : margin;

            const width = svg.node().getBoundingClientRect().width - currentMargin.left - currentMargin.right;
            const height = svg.node().getBoundingClientRect().height - currentMargin.top - currentMargin.bottom;
            const g = svg.append("g").attr("transform", `translate(${currentMargin.left},${currentMargin.top})`);

            const x = d3.scaleLinear().domain(d3.extent(data, d => d[xVar])).nice().range([0, width]);
            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
                .append("text").attr("y", 45).attr("x", width / 2).attr("text-anchor", "middle").attr("fill", "currentColor").text(xLabel);

            const y = d3.scaleLinear().domain(d3.extent(data, d => d[yVar])).nice().range([height, 0]);
            g.append("g").call(d3.axisLeft(y).tickFormat(d3.format("~s")))
                .append("text").attr("transform", "rotate(-90)").attr("y", -55).attr("x", -height / 2).attr("text-anchor", "middle").attr("fill", "currentColor").text(yLabel);
            
            const colorScale = d3.scaleOrdinal(d3.schemeTableau10).domain([...new Set(data.map(d => d[hueVar]))].sort());

            g.append('g').selectAll("dot").data(data).join("circle")
                .attr("cx", d => x(d[xVar])).attr("cy", d => y(d[yVar]))
                .style("fill", d => colorScale(d[hueVar])).style("opacity", 0.7)
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1);
                    tooltip.html(`<b>${d.make} (${d['body-style']})</b><br>${xLabel}: ${d[xVar]}<br>${yLabel}: ${d[yVar].toLocaleString()}`)
                        .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                }).on("mouseout", () => tooltip.style("opacity", 0))
                .attr("r", 0)
                .transition().duration(animate ? 500 : 0)
                .attr("r", 5);

            if(hasLegend) {
                const legendContainer = d3.select(legendSelector);
                legendContainer.html(""); // Clear previous legend
                const legendItems = legendContainer.selectAll(".legend-item")
                    .data(colorScale.domain())
                    .enter().append("div")
                    .attr("class", "legend-item flex items-center space-x-2 clickable")
                    .classed("hidden", d => hiddenLegendItems.has(d))
                    .on("click", function(event, d) {
                        if (hiddenLegendItems.has(d)) {
                            hiddenLegendItems.delete(d);
                        } else {
                            hiddenLegendItems.add(d);
                        }
                        updateDashboard();
                    });

                legendItems.append("div")
                    .style("width", "12px")
                    .style("height", "12px")
                    .style("background-color", d => colorScale(d))
                    .style("border-radius", "50%");

                legendItems.append("span")
                    .text(d => d);
            }
        }
        
        function drawBoxPlot(data, selector, catVar, numVar, xLabel, yLabel, animate) {
            const svg = d3.select(selector);
            svg.selectAll("*").remove();
            
            const isRotated = ['body-style', 'drive-wheels', 'symboling'].includes(catVar);
            const currentMargin = isRotated ? marginRotated : margin;

            const width = svg.node().getBoundingClientRect().width - currentMargin.left - currentMargin.right;
            const height = svg.node().getBoundingClientRect().height - currentMargin.top - currentMargin.bottom;
            const g = svg.append("g").attr("transform", `translate(${currentMargin.left},${currentMargin.top})`);

            const categories = [...new Set(data.map(d => d[catVar]))].sort((a,b) => d3.ascending(a,b));
            const x = d3.scaleBand().range([0, width]).domain(categories).padding(0.4);
            const xAxis = g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
            
            if (isRotated) {
                xAxis.selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");
            }
            if (catVar === 'symboling') {
                const symbolingMap = {'-2': 'V. Safe', '-1': 'Safe', '0': 'Neutral', '1': 'Risky', '2': 'V. Risky', '3': 'Most Risky'};
                xAxis.selectAll("text").text(d => symbolingMap[d] || d);
            }

            const y = d3.scaleLinear().domain([0, d3.max(data, d => d[numVar])]).nice().range([height, 0]);
            g.append("g").call(d3.axisLeft(y).tickFormat(d3.format("~s")))
                .append("text").attr("transform", "rotate(-90)").attr("y", -55).attr("x", -height/2).attr("text-anchor", "middle").attr("fill", "currentColor").text(yLabel);

            const groupedData = d3.group(data, d => d[catVar]);
            
            groupedData.forEach((group, key) => {
                const values = group.map(d => d[numVar]).sort(d3.ascending);
                const q1 = d3.quantile(values, .25);
                const median = d3.quantile(values, .5);
                const q3 = d3.quantile(values, .75);
                if (q1 === undefined || median === undefined || q3 === undefined) return;
                
                const boxG = g.append("g").attr("transform", `translate(${x(key)}, 0)`);
                
                boxG.append("rect")
                    .attr("x", 0).attr("width", x.bandwidth())
                    .style("fill", "var(--accent-primary)").attr("stroke", "var(--border-color)")
                    .on("mouseover", (event) => {
                        tooltip.style("opacity", 1).html(`<b>${key}</b><br>Median: ${d3.format("$,.0f")(median)}<br>Q1: ${d3.format("$,.0f")(q1)}<br>Q3: ${d3.format("$,.0f")(q3)}`)
                            .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                    }).on("mouseout", () => tooltip.style("opacity", 0))
                    .transition().duration(animate ? 800 : 0)
                    .attr("y", y(q3)).attr("height", y(q1) - y(q3));

                boxG.append("line")
                    .attr("x1", 0).attr("x2", x.bandwidth())
                    .attr("stroke", "var(--bg-secondary)").style("stroke-width", "2px")
                    .transition().duration(animate ? 800 : 0)
                    .attr("y1", y(median)).attr("y2", y(median));
            });
        }

        function drawViolinPlot(data, selector, catVar, numVar, xLabel, yLabel, animate) {
            const svg = d3.select(selector);
            svg.selectAll("*").remove();
            const width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = svg.node().getBoundingClientRect().height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const categories = [...new Set(data.map(d => d[catVar]))].sort();
            const x = d3.scaleBand().range([0, width]).domain(categories).padding(0.1);
            g.append("g").attr("transform", `translate(0, ${height})`).call(d3.axisBottom(x))
                .append("text").attr("y", 45).attr("x", width/2).attr("text-anchor", "middle").attr("fill", "currentColor").text(xLabel);

            const y = d3.scaleLinear().domain(d3.extent(data, d => d[numVar])).nice().range([height, 0]);
            g.append("g").call(d3.axisLeft(y))
                .append("text").attr("transform", "rotate(-90)").attr("y", -55).attr("x", -height/2).attr("text-anchor", "middle").attr("fill", "currentColor").text(yLabel);

            const histogram = d3.histogram().domain(y.domain()).thresholds(y.ticks(15)).value(d => d[numVar]);
            const sumstat = d3.group(data, d => d[catVar]);
            
            let maxNum = 0;
            sumstat.forEach(group => {
                let catBins = histogram(group);
                let max = d3.max(catBins, d => d.length);
                if (max > maxNum) maxNum = max;
            });
            const xNum = d3.scaleLinear().range([0, x.bandwidth()]).domain([-maxNum, maxNum]);

            g.selectAll("myViolin").data(sumstat).join("g")
                .attr("transform", d => `translate(${x(d[0])}, 0)`)
                .append("path")
                .datum(d => histogram(d[1] || []))
                .style("stroke", "none").style("fill", "var(--accent-secondary)")
                .attr("d", d3.area().x0(d => xNum(-d.length)).x1(d => xNum(d.length)).y(d => y(d.x0)).curve(d3.curveCatmullRom))
                .style("opacity", 0)
                .transition().duration(animate ? 800 : 0)
                .style("opacity", 0.7);
        }

        function drawCorrelationHeatmap(data, animate) {
            const svg = d3.select("#correlation-heatmap");
            svg.selectAll("*").remove();
            const localMargin = { top: 30, right: 30, bottom: 100, left: 100 };
            const width = svg.node().getBoundingClientRect().width - localMargin.left - localMargin.right;
            const height = svg.node().getBoundingClientRect().height - localMargin.top - localMargin.bottom;
            const g = svg.append("g").attr("transform", `translate(${localMargin.left},${localMargin.top})`);

            const columns = ['price', 'horsepower', 'curb-weight', 'engine-size', 'city-mpg', 'highway-mpg', 'wheel-base', 'length', 'width', 'symboling'];
            const matrix = calculateCorrelationMatrix(data, columns);

            const x = d3.scaleBand().range([0, width]).domain(columns).padding(0.05);
            g.append("g").style("font-size", 10).attr("transform", `translate(0, ${height})`).call(d3.axisBottom(x).tickSize(0))
               .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");

            const y = d3.scaleBand().range([height, 0]).domain(columns).padding(0.05);
            g.append("g").style("font-size", 10).call(d3.axisLeft(y).tickSize(0)).select(".domain").remove();

            const color = d3.scaleSequential(d3.interpolateRdBu).domain([-1, 1]);

            const heatmapData = [];
            for (let i = 0; i < columns.length; i++) {
                for (let j = 0; j < columns.length; j++) {
                    heatmapData.push({ x: columns[i], y: columns[j], value: matrix[i][j] });
                }
            }

            g.selectAll(".corr-rect").data(heatmapData, d => d.x+':'+d.y).join("rect")
                .attr("x", d => x(d.x)).attr("y", d => y(d.y))
                .attr("rx", 4).attr("ry", 4)
                .attr("width", x.bandwidth()).attr("height", y.bandwidth())
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1);
                    tooltip.html(`Corr(${d.x}, ${d.y}):<br><b>${d.value.toFixed(2)}</b>`)
                        .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 20) + "px");
                }).on("mouseout", () => tooltip.style("opacity", 0))
                .style("fill", d => color(d.value === undefined ? 0 : d.value))
                .style("opacity", 0)
                .transition().duration(animate ? 800 : 0)
                .style("opacity", 1);
            
            g.selectAll(".corr-text").data(heatmapData).join("text")
                .attr("x", d => x(d.x) + x.bandwidth() / 2)
                .attr("y", d => y(d.y) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .style("fill", d => Math.abs(d.value) > 0.7 ? "white" : "black")
                .text(d => d.value.toFixed(1))
                .style("opacity", 0)
                .transition().duration(animate ? 800 : 0)
                .style("opacity", 1);
        }

        function calculateCorrelationMatrix(data, columns) {
            const n = columns.length;
            const matrix = Array(n).fill(0).map(() => Array(n).fill(0));
            for (let i = 0; i < n; i++) {
                for (let j = i; j < n; j++) {
                    const col1 = columns[i];
                    const col2 = columns[j];
                    const validData = data.filter(d => d[col1] !== undefined && d[col2] !== undefined);
                    const xSeries = validData.map(d => d[col1]);
                    const ySeries = validData.map(d => d[col2]);
                    const correlation = d3.mean(xSeries.map((x_i, k) => (x_i - d3.mean(xSeries)) * (ySeries[k] - d3.mean(ySeries)))) / (d3.deviation(xSeries) * d3.deviation(ySeries));
                    matrix[i][j] = isNaN(correlation) ? 0 : correlation;
                    matrix[j][i] = isNaN(correlation) ? 0 : correlation;
                }
            }
            return matrix;
        }
    });
    </script>
</body>
</html>
