<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaceCraft: F1 Data Visualization Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #F9FAFB; /* text-gray-50 */
        }
       .chart-container {
            position: relative;
            height: 50vh;
            width: 100%;
        }
        #map-container {
            height: 70vh;
            border-radius: 0.5rem;
        }
       .leaflet-popup-content-wrapper,.leaflet-popup-tip {
            background: #1F2937; /* bg-gray-800 */
            color: #F9FAFB; /* text-gray-50 */
        }
       .leaflet-control-zoom-in,.leaflet-control-zoom-out {
            background-color: #1F2937!important;
            color: #F9FAFB!important;
        }
       .leaflet-control-attribution a {
            color: #9CA3AF;
        }
       .tab-button {
            transition: all 0.3s ease;
        }
       .tab-button.active {
            background-color: #EF4444; /* bg-red-500 */
            color: white;
        }
       .tab-content {
            display: none;
        }
       .tab-content.active {
            display: block;
        }
       .custom-select {
            background-color: #1F2937;
            border: 1px solid #374151;
            color: #F9FAFB;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-gray-900/80 backdrop-blur-sm shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12M3.75 3h16.5M3.75 3v1.5M16.5 3v1.5M3.75 16.5a3 3 0 003 3h6a3 3 0 003-3M6.75 19.5v-3h10.5v3M12 12.75a1.125 1.125 0 110-2.25 1.125 1.125 0 010 2.25z" />
                    </svg>
                    <h1 class="text-2xl font-bold text-white ml-2">RaceCraft Dashboard</h1>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div id="loading-indicator" class="text-center py-16">
            <div role="status">
                <svg aria-hidden="true" class="inline w-12 h-12 text-gray-200 animate-spin dark:text-gray-600 fill-red-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                    <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                </svg>
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-4 text-lg font-medium text-gray-300">Crafting the race data... Please wait.</p>
        </div>

        <div id="dashboard" class="hidden">
            <div class="mb-8 border-b border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button class="tab-button active py-4 px-6 text-sm font-medium text-gray-300 hover:bg-gray-700 rounded-t-lg" data-tab="overview">Overview</button>
                    <button class="tab-button py-4 px-6 text-sm font-medium text-gray-300 hover:bg-gray-700 rounded-t-lg" data-tab="drivers">Driver Analysis</button>
                    <button class="tab-button py-4 px-6 text-sm font-medium text-gray-300 hover:bg-gray-700 rounded-t-lg" data-tab="constructors">Constructor Analysis</button>
                    <button class="tab-button py-4 px-6 text-sm font-medium text-gray-300 hover:bg-gray-700 rounded-t-lg" data-tab="circuits">Circuit Analysis</button>
                    <button class="tab-button py-4 px-6 text-sm font-medium text-gray-300 hover:bg-gray-700 rounded-t-lg" data-tab="race-analysis">Race Analysis</button>
                </nav>
            </div>

            <div id="tab-content-container">
                <div id="overview" class="tab-content active">
                    <h2 class="text-3xl font-bold mb-6 text-red-500">Global F1 Insights</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-gray-400 text-sm font-medium uppercase">Total Races</h3>
                            <p id="total-races" class="text-4xl font-bold text-white mt-2">0</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-gray-400 text-sm font-medium uppercase">Total Drivers</h3>
                            <p id="total-drivers" class="text-4xl font-bold text-white mt-2">0</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-gray-400 text-sm font-medium uppercase">Total Constructors</h3>
                            <p id="total-constructors" class="text-4xl font-bold text-white mt-2">0</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-gray-400 text-sm font-medium uppercase">Total Circuits</h3>
                            <p id="total-circuits" class="text-4xl font-bold text-white mt-2">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl">
                            <h3 class="text-xl font-bold mb-4 text-white">Driver Nationalities</h3>
                            <div class="chart-container"><canvas id="driver-nationalities-chart"></canvas></div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl">
                            <h3 class="text-xl font-bold mb-4 text-white">Constructor Nationalities</h3>
                            <div class="chart-container"><canvas id="constructor-nationalities-chart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="drivers" class="tab-content">
                    <h2 class="text-3xl font-bold mb-6 text-red-500">Driver Analysis</h2>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl">
                        <h3 class="text-xl font-bold mb-4 text-white">Top 20 Drivers by Race Wins</h3>
                        <div class="chart-container"><canvas id="driver-wins-chart"></canvas></div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl mt-8">
                        <h3 class="text-xl font-bold mb-4 text-white">Driver Career Deep Dive</h3>
                        <div class="mb-4">
                            <label for="driver-select" class="block text-sm font-medium text-gray-300 mb-2">Select a Driver:</label>
                            <select id="driver-select" class="custom-select block w-full md:w-1/3 p-2.5 rounded-md text-base">
                                </select>
                        </div>
                        <div class="chart-container"><canvas id="career-chart"></canvas></div>
                    </div>
                </div>

                <div id="constructors" class="tab-content">
                    <h2 class="text-3xl font-bold mb-6 text-red-500">Constructor Analysis</h2>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl">
                        <h3 class="text-xl font-bold mb-4 text-white">Top 20 Constructors by Race Wins</h3>
                        <div class="chart-container"><canvas id="constructor-wins-chart"></canvas></div>
                    </div>
                </div>

                <div id="circuits" class="tab-content">
                    <h2 class="text-3xl font-bold mb-6 text-red-500">Circuit Analysis</h2>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl">
                        <h3 class="text-xl font-bold mb-4 text-white">Global Circuit Map</h3>
                        <div id="map-container"></div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl mt-8">
                        <h3 class="text-xl font-bold mb-4 text-white">Number of Races Per Circuit (Top 20)</h3>
                        <div class="chart-container"><canvas id="races-per-circuit-chart"></canvas></div>
                    </div>
                </div>
                
                <div id="race-analysis" class="tab-content">
                    <h2 class="text-3xl font-bold mb-6 text-red-500">Race Performance Analysis</h2>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl">
                        <h3 class="text-xl font-bold mb-4 text-white">Qualifying Position vs. Finish Position</h3>
                        <div class="mb-4">
                            <label for="race-select-scatter" class="block text-sm font-medium text-gray-300 mb-2">Select a Race:</label>
                            <select id="race-select-scatter" class="custom-select block w-full md:w-1/3 p-2.5 rounded-md text-base">
                                </select>
                        </div>
                        <div class="chart-container"><canvas id="qualifying-scatter-chart"></canvas></div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl mt-8">
                        <h3 class="text-xl font-bold mb-4 text-white">Lap Time Distribution</h3>
                        <div class="mb-4">
                            <label for="race-select-histogram" class="block text-sm font-medium text-gray-300 mb-2">Select a Race:</label>
                            <select id="race-select-histogram" class="custom-select block w-full md:w-1/3 p-2.5 rounded-md text-base">
                                </select>
                        </div>
                        <div class="chart-container"><canvas id="lap-time-histogram"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE ---
            const dataStore = {};
            const chartInstances = {};
            let mapInstance = null;

            // --- DOM Elements ---
            const loadingIndicator = document.getElementById('loading-indicator');
            const dashboard = document.getElementById('dashboard');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const driverSelect = document.getElementById('driver-select');
            const raceSelectScatter = document.getElementById('race-select-scatter');
            const raceSelectHistogram = document.getElementById('race-select-histogram');

            // --- DATA LOADING ---
            const files = [
                'public/Rawdata/circuits.csv', 'public/Rawdata/constructor_results.csv', 'public/Rawdata/constructor_standings.csv',
                'public/Rawdata/constructors.csv', 'public/Rawdata/driver_standings.csv', 'public/Rawdata/drivers.csv', 'public/Rawdata/lap_times.csv',
                'public/Rawdata/pit_stops.csv', 'public/Rawdata/qualifying.csv', 'public/Rawdata/races.csv', 'public/Rawdata/results.csv',
                'public/Rawdata/seasons.csv', 'public/Rawdata/sprint_results.csv', 'public/Rawdata/status.csv'
            ];
            
            function parseCSV(csvText) {
                const lines = csvText.trim().split('\\n');
                const headers = lines.split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                return lines.slice(1).map(line => {
                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    const obj = {};
                    headers.forEach((header, i) => {
                        let value = values[i]? values[i].trim().replace(/^"|"$/g, '') : '';
                        obj[header] = value;
                    });
                    return obj;
                });
            }

            async function loadData() {
                try {
                    const promises = files.map(file =>
                        fetch(file)
                       .then(response => {
                            if (!response.ok) throw new Error(`Failed to load ${file}`);
                            return response.text();
                        })
                       .then(text => {
                            const key = file.replace('.csv', '');
                            dataStore[key] = parseCSV(text);
                        })
                    );
                    await Promise.all(promises);
                    console.log('All data loaded:', dataStore);
                    initializeApp();
                } catch (error) {
                    console.error("Error loading data:", error);
                    loadingIndicator.innerHTML = `<p class="text-red-500">Failed to load race data. Please check file paths and console for errors.</p>`;
                }
            }

            // --- INITIALIZATION ---
            function initializeApp() {
                loadingIndicator.style.display = 'none';
                dashboard.style.display = 'block';

                setupTabs();
                populateSelectors();
                
                // Initial chart renders
                renderOverviewTab();
                renderDriverTab();
                renderConstructorTab();
                renderCircuitTab();
                renderRaceAnalysisTab();

                // Add event listeners
                driverSelect.addEventListener('change', (e) => createCareerChart(e.target.value));
                raceSelectScatter.addEventListener('change', (e) => createQualifyingScatter(e.target.value));
                raceSelectHistogram.addEventListener('change', (e) => createLapTimeHistogram(e.target.value));
            }

            function setupTabs() {
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        button.classList.add('active');
                        document.getElementById(button.dataset.tab).classList.add('active');
                        
                        // Special handling for map resizing
                        if (button.dataset.tab === 'circuits' && mapInstance) {
                            setTimeout(() => mapInstance.invalidateSize(), 10);
                        }
                    });
                });
            }

            function populateSelectors() {
                // Driver Selector
                const sortedDrivers =.sort((a, b) => a.surname.localeCompare(b.surname));
                driverSelect.innerHTML = '<option value="">-- Select a Driver --</option>';
                sortedDrivers.forEach(driver => {
                    driverSelect.innerHTML += `<option value="${driver.driverId}">${driver.forename} ${driver.surname}</option>`;
                });

                // Race Selectors
                const sortedRaces =.sort((a, b) => b.year - a.year |

| b.round - a.round);
                let raceOptions = '<option value="">-- Select a Race --</option>';
                sortedRaces.forEach(race => {
                    raceOptions += `<option value="${race.raceId}">${race.year} - ${race.name}</option>`;
                });
                raceSelectScatter.innerHTML = raceOptions;
                raceSelectHistogram.innerHTML = raceOptions;
            }

            // --- CHART RENDERING FUNCTIONS ---
            function renderChart(canvasId, type, data, options) {
                if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                }
                const ctx = document.getElementById(canvasId).getContext('2d');
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            }

            // --- TAB-SPECIFIC RENDERERS ---
            function renderOverviewTab() {
                document.getElementById('total-races').textContent = dataStore.races.length;
                document.getElementById('total-drivers').textContent = dataStore.drivers.length;
                document.getElementById('total-constructors').textContent = dataStore.constructors.length;
                document.getElementById('total-circuits').textContent = dataStore.circuits.length;
                createNationalityPieChart('driver-nationalities-chart', dataStore.drivers, 'nationality');
                createNationalityPieChart('constructor-nationalities-chart', dataStore.constructors, 'nationality');
            }

            function renderDriverTab() {
                createDriverWinsChart();
                createCareerChart(dataStore.drivers.driverId); // Default to first driver
            }

            function renderConstructorTab() {
                createConstructorWinsChart();
            }

            function renderCircuitTab() {
                createCircuitMap();
                createRacesPerCircuitChart();
            }
            
            function renderRaceAnalysisTab() {
                createQualifyingScatter(dataStore.races.raceId); // Default to most recent race
                createLapTimeHistogram(dataStore.races.raceId);
            }

            // --- CHART CREATION LOGIC ---

            function createNationalityPieChart(canvasId, dataSource, property) {
                const counts = dataSource.reduce((acc, item) => {
                    acc[item[property]] = (acc[item[property]] |

| 0) + 1;
                    return acc;
                }, {});
                
                const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                const top10 = sorted.slice(0, 10);
                const others = sorted.slice(10).reduce((sum, item) => sum + item[1], 0);
                
                const labels = top10.map(item => item);
                const data = top10.map(item => item[1]);
                if (others > 0) {
                    labels.push('Others');
                    data.push(others);
                }

                renderChart(canvasId, 'pie', {
                    labels,
                    datasets: }]
                }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#F9FAFB' } } } });
            }

            function createDriverWinsChart() {
                const driverWins = dataStore.results
                   .filter(r => r.position === '1')
                   .reduce((acc, r) => {
                        acc[r.driverId] = (acc[r.driverId] |

| 0) + 1;
                        return acc;
                    }, {});

                const sortedWins = Object.entries(driverWins).sort((a, b) => b[1] - a[1]).slice(0, 20);
                const driverIdToName = dataStore.drivers.reduce((acc, d) => {
                    acc[d.driverId] = `${d.forename} ${d.surname}`;
                    return acc;
                }, {});

                renderChart('driver-wins-chart', 'bar', {
                    labels: sortedWins.map(d => driverIdToName[d]),
                    datasets:), backgroundColor: '#EF4444' }]
                }, { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { ticks: { color: '#D1D5DB' } }, y: { ticks: { color: '#D1D5DB' } } }, plugins: { legend: { display: false } } });
            }
            
            function createConstructorWinsChart() {
                const constructorWins = dataStore.results
                   .filter(r => r.position === '1')
                   .reduce((acc, r) => {
                        acc[r.constructorId] = (acc[r.constructorId] |

| 0) + 1;
                        return acc;
                    }, {});

                const sortedWins = Object.entries(constructorWins).sort((a, b) => b[1] - a[1]).slice(0, 20);
                const constructorIdToName = dataStore.constructors.reduce((acc, c) => {
                    acc[c.constructorId] = c.name;
                    return acc;
                }, {});

                renderChart('constructor-wins-chart', 'bar', {
                    labels: sortedWins.map(c => constructorIdToName[c]),
                    datasets:), backgroundColor: '#3B82F6' }]
                }, { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { ticks: { color: '#D1D5DB' } }, y: { ticks: { color: '#D1D5DB' } } }, plugins: { legend: { display: false } } });
            }

            function createCareerChart(driverId) {
                if (!driverId) return;
                const driverStandings = dataStore.driver_standings.filter(ds => ds.driverId === driverId);
                const raceYearMap = new Map(dataStore.races.map(r => [r.raceId, r.year]));
                
                const statsByYear = {};
                driverStandings.forEach(ds => {
                    const year = raceYearMap.get(ds.raceId);
                    if (!statsByYear[year] |

| parseInt(ds.points) > statsByYear[year].points) {
                        statsByYear[year] = { points: parseInt(ds.points), wins: parseInt(ds.wins) };
                    }
                });

                const sortedYears = Object.keys(statsByYear).sort((a, b) => a - b);
                
                renderChart('career-chart', 'bar', {
                    labels: sortedYears,
                    datasets:.wins), backgroundColor: 'rgba(239, 68, 68, 0.6)', yAxisID: 'yWins' },
                        { label: 'Points', data: sortedYears.map(y => statsByYear[y].points), backgroundColor: 'rgba(59, 130, 246, 0.6)', type: 'line', tension: 0.1, yAxisID: 'yPoints' }
                    ]
                }, { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#D1D5DB' } }, yWins: { position: 'left', title: { display: true, text: 'Wins', color: '#F9FAFB' }, ticks: { color: '#D1D5DB', stepSize: 1 } }, yPoints: { position: 'right', title: { display: true, text: 'Points', color: '#F9FAFB' }, grid: { drawOnChartArea: false }, ticks: { color: '#D1D5DB' } } }, plugins: { legend: { labels: { color: '#F9FAFB' } } } });
            }

            function createCircuitMap() {
                if (mapInstance) mapInstance.remove();
                mapInstance = L.map('map-container').setView(, 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    maxZoom: 19
                }).addTo(mapInstance);

                dataStore.circuits.forEach(circuit => {
                    if (circuit.lat && circuit.lng) {
                        L.marker([circuit.lat, circuit.lng])
                           .addTo(mapInstance)
                           .bindPopup(`<b>${circuit.name}</b><br>${circuit.location}, ${circuit.country}`);
                    }
                });
            }
            
            function createRacesPerCircuitChart() {
                const raceCounts = dataStore.races.reduce((acc, race) => {
                    acc[race.circuitId] = (acc[race.circuitId] |

| 0) + 1;
                    return acc;
                }, {});

                const sortedCounts = Object.entries(raceCounts).sort((a, b) => b[1] - a[1]).slice(0, 20);
                const circuitIdToName = dataStore.circuits.reduce((acc, c) => {
                    acc[c.circuitId] = c.name;
                    return acc;
                }, {});

                renderChart('races-per-circuit-chart', 'bar', {
                    labels: sortedCounts.map(c => circuitIdToName[c]),
                    datasets:), backgroundColor: '#22C55E' }]
                }, { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#D1D5DB' } }, y: { ticks: { color: '#D1D5DB' } } }, plugins: { legend: { display: false } } });
            }

            function createQualifyingScatter(raceId) {
                if (!raceId) return;
                const qualifyingResults = dataStore.qualifying.filter(q => q.raceId === raceId);
                const raceResults = dataStore.results.filter(r => r.raceId === raceId);

                const data = qualifyingResults.map(q => {
                    const raceResult = raceResults.find(r => r.driverId === q.driverId);
                    if (raceResult && raceResult.position) {
                        return { x: parseInt(q.position), y: parseInt(raceResult.position) };
                    }
                    return null;
                }).filter(Boolean);

                renderChart('qualifying-scatter-chart', 'scatter', {
                    datasets:
                }, { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Grid Position', color: '#F9FAFB' }, ticks: { color: '#D1D5DB' } }, y: { title: { display: true, text: 'Finish Position', color: '#F9FAFB' }, ticks: { color: '#D1D5DB' } } }, plugins: { legend: { display: false } } });
            }
            
            function createLapTimeHistogram(raceId) {
                if (!raceId) return;
                const lapTimes = dataStore.lap_times
                   .filter(lt => lt.raceId === raceId && lt.milliseconds)
                   .map(lt => parseInt(lt.milliseconds) / 1000); // Convert to seconds

                if (lapTimes.length === 0) return;

                // Basic outlier removal (e.g., laps > 1.5 * median)
                const sortedTimes =.sort((a, b) => a - b);
                const median = sortedTimes;
                const filteredTimes = sortedTimes.filter(t => t < median * 1.5);

                const minTime = Math.floor(Math.min(...filteredTimes));
                const maxTime = Math.ceil(Math.max(...filteredTimes));
                const binSize = 1; // 1 second bins
                const bins = Math.ceil((maxTime - minTime) / binSize);
                
                const histogramData = new Array(bins).fill(0);
                const labels = new Array(bins).fill(0).map((_, i) => `${minTime + i * binSize}s`);

                filteredTimes.forEach(time => {
                    const binIndex = Math.floor((time - minTime) / binSize);
                    if (binIndex >= 0 && binIndex < bins) {
                        histogramData[binIndex]++;
                    }
                });

                renderChart('lap-time-histogram', 'bar', {
                    labels,
                    datasets:
                }, { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Lap Time (seconds)', color: '#F9FAFB' }, ticks: { color: '#D1D5DB', maxRotation: 90, minRotation: 45 } }, y: { title: { display: true, text: 'Number of Laps', color: '#F9FAFB' }, ticks: { color: '#D1D5DB' } } }, plugins: { legend: { display: false } } });
            }

            // --- Start the application ---
            loadData();
        });
    </script>

</body>
</html>
